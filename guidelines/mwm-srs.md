# MONAI Deploy Workflow Manager Requirements

## Overview

![MONAI Deploy Workflow Manager](./static/mwm.png)

The MONAI Deploy Workflow Manager (MWM) is the central hub of the MONAI Deploy platform. It manages MONAI Deploy workflows and executes the tasks specified with the medical data received by the MONAI Informatics Gateway (or your custom ingestion service). It is also responsible for monitoring task execution statuses and routing any results produced by the applications back to the configured destinations.

## Scope

The scope of this document is limited to the MONAI Deploy Workflow Manager. There are other subsystems of the MONAI Deploy platform, such as [MONAI Deploy Informatics Gateway](https://github.com/Project-MONAI/monai-deploy-informatics-gateway) (responsible for interoperability with external systems) and [MONAI App SDK](https://github.com/Project-MONAI/monai-app-sdk) (which provides the necessary APIs for the application developer to interact with the MWM). However, this requirements document does not address specifications belonging to those subsystems.

## Goal

This proposal aims to enlist, prioritize, and clarify the requirements for MONAI Deploy Workflow Manager. Developers working on different software modules in MONAI Deploy Workflow Manager SHALL use this specification as a guideline when designing and implementing software for the MONAI Deploy Workflow Manager.

## Success Criteria

MWM SHALL process data that comes into the system, execute user-configured workflows, and route results back to external systems.

## Attributes of a Requirement

Each requirement defined in this document must include the following attributes:

**Requirement Body**: Describes the goal and purpose behind the requirement.

**Background**: Provides necessary background to understand the context of the requirements.

**Verification Strategy**: A high-level plan on how to test this requirement at a system level.

**Target Release**: Specifies the target for the release of MONAI Deploy Workflow Manager.

## Definitions, Acronyms, Abbreviations

| Term              | Definition                                                                                                                                                                                                                                                                                                                |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| MIG               | MONAI Deploy Informatics Gateway                                                                                                                                                                                                                                                                                          |
| MWM               | MONAI Deploy Workflow Manager                                                                                                                                                                                                                                                                                             |
| Clinical Workflow | A clinical workflow is represented as a DAG and contains individual pieces of work called Tasks, arranged with dependencies and data flows taken into account. The Clinical Workflow is designed at deploy-time.                                                                                                         |
| Task              | A Task is an individual piece of work in a Clinical Workflow. Each task can be of the following types at a minimum: 1. A MONAI Application Package (MAP). 2. An Argo Workflow where each step is a container. 3. A client that invokes a web service synchronously. 4. A client that invokes a web service asynchronously |
| Evaluator         | An Evaluator performs checks based on conditions defined with metadata keys. Based on the evaluation results, a specific downstream task is executed.                                                                                                                                                                     |
| Metadata          | Metadata qualifies run-time characteristics of a clinical workflow. Each task can ingest one or more metadata elements & can also generate more. The execution environment provides a way to store metadata and access it.                                                                                                 |
| Export Sink | An export sink associates result generated by a workflow with a data export service. |
| DAG | Directed Acyclic Graphs |
| Workflow | A DAG composed of one or more tasks. |

## (REQ-DI) Data Ingestion Requirements

### [REQ-DI-001] MWM SHALL be notified when data arrives at the data ingestion services via shared virtual storage

#### Background

Medical imaging data are relatively large, and transferring data between devices takes a significant amount of time of any given workflow. Therefore, using shared virtual storage would reduce the amount of data and time transferring across devices.

#### Verification Strategy

Verify that the MWM gets notified when the ingestion services, e.g., MIG, receive data.

#### Target Release

MONAI Deploy Workflow Manager R1

### [REQ-DI-002] MWM SHALL allow users to upload data

#### Background

With the design of MONAI Deploy, the MWM does not interface with medical systems directly but rather through the Informatics Gateway (a data ingestion & export service). Therefore, there is a need to provide APIs to interface with any data ingestion services. In addition, it allows the users of the platform to extend these APIs to interface their systems using different messaging protocols or storage services.

#### Verification Strategy

Verify that payloads can be uploaded from data ingestion services and dispatched to the data discovery service.

#### Target Release

MONAI Deploy Workload Manager Rx

### [REQ-DI-003] MWM SHALL allow data to be associated with one or more workflows

#### Background

In scenarios where workflows are known for a given dataset, MWM could launch the specified workflow without launching all of them to reduce processing time.

#### Verification Strategy

Verify that WM only launches specified workflows when specified with a given dataset.

#### Target Release

MONAI Deploy Workflow Manager R1

## (REQ-WF) Workflow/Task Requirements

### [REQ-WF-001] MWM SHALL allow chaining of tasks to form a workflow (DAG)

#### Background

Often, a workflow may include more than one task.  E.g., a workflow with a task to analyze body part of a given DICOM dataset. Then, it evaluates the result to execute another task that runs an inference model to detect possible brain tumors. This requirement enables the ability to compose a DAG with complex decisions.

#### Verification Strategy

Verify the system processes a given workflow (DAG) as described.

#### Target Release

MONAI Deploy Workflow Manager R1


### [REQ-WF-002] MWM SHALL be able to process multiple workflows for a given payload

#### Background

Given that a workflow allows one or many tasks, users may have one single DAG containing all tasks or many DAGs, each with a single task. This requirement provides options for the users based on their deployment needs and allows all deployed workflows to be launched when a payload arrives at the system.

#### Verification Strategy

Verify that multiple workflows may be deployed and processed.
#### Target Release

MONAI Deploy Workflow Manager R1


### [REQ-WF-003] MWM SHALL be able to define evaluators before and after executing a task

#### Background

Given a workflow, a user may want to execute a downstream task only if the result meets some criteria. E.g., a task that runs liver segmentation may require the output of a body part analyzer task to acknowledge that the given DICOM dataset is indeed a liver. Or, a task may only want to export the results when some conditions are met.

#### Verification Strategy

Define a workflow with tasks with pre and post evaluators and verify that both pre and post evaluators correctly return the expected values with the given input.

#### Target Release

MONAI Deploy Workflow Manager R1

### [REQ-WF-004] MWM SHALL be able to execute a task with any external orchestration engine or service

#### Background

Often, in a workflow, users may want to connect to an existing service or reuse an orchestration engine that IT has provisioned. This requirement enables flexibility and extensibility of executing a task with any external service.

#### Verification Strategy

Define a workflow with tasks that utilize external services, such as Argo, and verify that the task executes successfully.

#### Target Release

MONAI Deploy Workflow Manager R1

### [REQ-WF-005] MWM SHALL allow tasks to join and feed results into a downstream task

#### Background

In a multi-modality workflow, a task may need to create a report based on multiple upstream tasks where each runs an inference model on a different modality. This requirement enables a task to wait for the results from multiple upstream tasks before it executes.

#### Verification Strategy

Define a workflow where a task waits for multiple upstream tasks to complete.

#### Target Release

MONAI Deploy Workflow Manager R2


## (REQ-DX) Data Export Requirements

### [REQ-DX-001] MWM SHALL be able to route data to multiple sinks

#### Background

AI applications and medical imaging algorithms often output data in different formats to be exported back to medical devices for reading, storage, or validation. The concept of a sink is to provide data export services an easy way to export results to external devices.

#### Verification Strategy

Verify that the results can be exported to multiple destinations.

#### Target Release

MONAI Deploy Workflow Manager R1

### [REQ-DX-002] MWM SHALL allow users to create custom sinks

#### Background

Besides industry-standard protocols, such as DICOM, there may be other proprietary methods of transmitting data. This requirement enables their services to pick up any results produced by their workflows.

#### Verification Strategy

Create a workflow to simulate an export service by implementing available APIs.

#### Target Release

MONAI Deploy Workflow Manager R1

## (REQ-FR) Functional Requirements


### [REQ-FR-001] MWM SHALL track status/states of all tasks initiated with external orchestration engines and services

#### Background

Internally, in MWM, many subcomponents need to know the state and statuses of a running task. Therefore, it is ideal to have a dedicated component that queries all the configured orchestration engines and services to share that information among other system parts.

#### Verification Strategy

Set up MWM with two orchestration engines or services, trigger a couple of tasks, and ensure statues and states are stored in MWM.

#### Target Release

MONAI Deploy Workflow Manager R1

### [REQ-FR-002] MWM SHALL provide a mechanism for clients to subscribe to notifications

MWM SHALL provide a mechanism so that users or clients can subscribe to the notification service to get job status or other system information.

#### Background

Maintainers typically require real-time or (daily, hourly, weekly) summaries on any failures experienced by the system, especially in logical errors in running applications.

#### Verification Strategy

Compose a MAP that errors out and expect a notification to be sent to the subscribers.

#### Target Release

MONAI Deploy Workflow Manager R3

### [REQ-FR-003] MWM SHALL allow users to define storage cleanup rules

MWM SHALL provide functionalities to enable user define policy for storage clean-up.

#### Background

Often medical records, especially medical images, requires a large amount of disk storage, and given that disk storage space is always limited, there must exist a method to remove them. For MWM, data associated with a workflow or a task that completes in a successful state may be removed. However, jobs that failed may need to be retained for further investigation.

#### Verification Strategy

Verify that payloads are removed based on users' configuration.

#### Target Release

MONAI Deploy Workflow Manager R2
