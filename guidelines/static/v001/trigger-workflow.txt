# Created at https://sequencediagram.org/
title Workload Manager v0.1.0 (DICOM ONLY & single MAP)

actor User
participant "MONAI\nInformatics Gateway" as MIG

participantgroup Workload Manager Core
participant "File API" as FileAPI
database "MWM Database" as DB
fontawesome f0a0 "Storage" as Storage
participant "App Discovery Service" as ADS
participant "Job Service" as JSS
participant "Result Collection Service" as DECS
participant "Sink Routing Service" as SRS
end

participantgroup Orchestration Mediator Service
participant "Orchestration Engine Plugin" as OEP
participant "Argo Plugin" as ARP
end

participantgroup Third Party
participant Argo
end

activate ADS

User->MIG: C-STORE-RQ (S1)
activate User
activate MIG
User<--MIG: C-STORE-RSP
MIG->FileAPI: File.Upload
activate FileAPI
note over MIG,FileAPI:Upload metadata:\n* Correlation ID\n* Source (Called-AET)\n* (Optional) Application IDs
rbox right of FileAPI: Extract DICOM headers
FileAPI->DB: Store metadata (DICOM headers)
FileAPI->Storage: Save instance
FileAPI->ADS: Notify instance
deactivate FileAPI
ADS->JSS: Configure bucket A with timeout
JSS->JSS: Activate bucket A
activate JSS
ADS->JSS: Put S1 in bucket A
User->MIG: C-STORE-RQ (S2)
User<--MIG: C-STORE-RSP
MIG->FileAPI: File.Upload
activate FileAPI
rbox right of FileAPI: Extract DICOM headers
FileAPI->DB: Store metadata (DICOM headers)
FileAPI->Storage: Save instance
FileAPI->ADS: Notify instance
deactivate FileAPI
ADS->JSS: Put S2 in bucket A
JSS->JSS: Bucket timeout
JSS->JSS: Schedule workflow A
JSS->DB: Save workflow A
deactivate JSS
JSS->DB: Load scheduled jobs
activate JSS
JSS->OEP:Launch workflow A
activate OEP
OEP->ARP: Launch workflow A
activate ARP
ARP->Argo: Launch workflow A
activate Argo
ARP<--Argo: Response
deactivate Argo
OEP<--ARP: Response
deactivate ARP
JSS<--OEP:Response
JSS->DB: Update workflow A
deactivate OEP
deactivate JSS
DECS->DB: Load active workflows
activate DECS
DECS->OEP: Poll workflow A
activate OEP
OEP->ARP: Poll job status A
activate ARP
ARP->Argo: Poll job status A
activate Argo
ARP<--Argo: Response
deactivate Argo
OEP<--ARP: Response
deactivate ARP

User->MIG: C-STORE-RQ (B1)
User<--MIG: C-STORE-RSP
deactivate User

DECS<--OEP: Response
deactivate OEP
DECS->Storage: Save results to storage
DECS->DB: Load app-to-sink mapping information
DECS->SRS: Forward results to sinks
activate SRS
SRS->DB: Register results for sink
DECS<--SRS: Response
deactivate SRS

DECS->DB: Save results metadata

deactivate DECS
MIG->FileAPI: File.Upload
activate FileAPI
deactivate MIG
FileAPI->DB: Store metadata (DICOM headers)
FileAPI->Storage: Save instance
FileAPI->ADS: Notify instance
deactivate FileAPI
ADS->JSS: Configure bucket B with timeout
JSS->JSS: Activate bucket B
activate JSS
ADS->JSS: Put B1 in bucket B
JSS->JSS: Bucket timeout
JSS->JSS: Schedule workflow B
deactivate JSS
JSS->DB: Save workflow B



JSS->DB: Load scheduled jobs
activate JSS
JSS->OEP:Launch workflow B
activate OEP
OEP->ARP: Launch workflow B
activate ARP
ARP->Argo: Launch workflow B
activate Argo
ARP<--Argo: Response
deactivate Argo
OEP<--ARP: Response
deactivate ARP
JSS<--OEP:Response
JSS->DB: Update workflow B
deactivate OEP
deactivate JSS
DECS->DB: Load active workflows
activate DECS
DECS->OEP: Poll workflow B
activate OEP
OEP->ARP: Poll job status B
activate ARP
ARP->Argo: Poll job status B
activate Argo
ARP<--Argo: Response
deactivate Argo
OEP<--ARP: Response
deactivate ARP

DECS<--OEP: Response
deactivate OEP
DECS->Storage: Save results to storage
DECS->DB: Load app-to-sink mapping information
DECS->SRS: Forward results to sinks
activate SRS
SRS->DB: Register results for sink
DECS<--SRS: Response
deactivate SRS
DECS->DB: Save results metadata
deactivate DECS
